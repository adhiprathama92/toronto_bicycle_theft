---
title: "Cluster Analysis of Neigbourhoods in Toronto Based on Bicycle Theft Cases"
author: "Pande Adhi Prathama"
date: "01/10/2021"
output: html_document
---

# Prologue

In this exercise, we aim to perform cluster analysis of neighbourhoods in Toronto based on bicycle theft cases which reported from 2014 - 2020.

To perform the analysis, we use following libraries.

```{r, message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(factoextra)
```

The data set we use to perform the analysis is provided by Toronto Police Service (link: <https://data.torontopolice.on.ca/datasets/bicycle-thefts/explore?location=43.727864%2C-79.122754%2C9.64>).

Some variables from original dataset have been removed from the analysis, with details as follow:

-   "X", "Y", "Longitude", and "Latitude": as we are not concerned with the exact geographical detail of each theft case.

-   "Hood_ID": as this variable contains similar information to "NeighbourhoodName".

-   Details of Occurrence and Report Dates (e.g Day, Month, Year, etc).

-   Detailed information of stolen bicycles, apart from 'Bike_Type' variable: as we are more interested to the number of case instead of bike.

-   "ObjectId2": as this variable contains similar information to "OBJECTID"

```{r, message=FALSE}
bike_theft <- read.csv(url("https://raw.githubusercontent.com/adhiprathama92/toronto_bicycle_theft_data/main/Bicycle_Thefts.csv"))
bike_theft <- bike_theft %>%
  select(-c("Ã¯..X", "Y", "Hood_ID", "Occurrence_Year", "Occurrence_Month","Occurrence_DayOfWeek","Occurrence_DayOfMonth","Occurrence_DayOfYear","Occurrence_Hour","Report_Year", "Report_Month","Report_DayOfWeek","Report_DayOfMonth","Report_DayOfYear","Report_Hour", "Longitude", "Latitude", "ObjectId2", "Bike_Make", "Bike_Model", "Bike_Speed", "Bike_Colour", "Cost_of_Bike"))
bike_theft
```

# Understanding Data

We notice that majority of variables have 'character' data type.

```{r}
str(bike_theft)
```

'Occurrence_Date' and 'Report_Date' variables are classified as 'character' instead of 'date and time'. Hence, we need to reclassify those variables to 'POSIXct'.

Interestingly, we also notice that there are 439 entries which shows gap year between Occurrence Date and Report Date. Up until now, there is no information found on why this is happened. From the time being, we will utilise **Report Date** for our analysis as we assume the police will do investigation right after the case is reported.

```{r}
#change occurance date and report date tp POSIXct data type
bike_theft <- bike_theft %>%
  mutate(Occurrence_Date = as.POSIXct(Occurrence_Date), Report_Date = as.POSIXct(Report_Date))

str(bike_theft)
```

```{r, message=FALSE}
#figure out gap year between occurrence vs report
bike_theft %>%
  mutate(Occurrence_Year = year(Occurrence_Date), Report_Year = year(Report_Date)) %>%
  group_by(Occurrence_Year, Report_Year) %>%
  summarise(Gap_Occurrence_Report = Report_Year - Occurrence_Year, frequency = n()) %>%
  distinct() %>%
  filter(Gap_Occurrence_Report > 0)
```

Further, on 'Bike_Type' variable, the data author also provide definition of each abbreviation as follow. (refer to: <https://torontops.maps.arcgis.com/sharing/rest/content/items/332f6e958b704d9aa023e7c3487f710f/data>)

-   BM : BMX
-   EL : Electric
-   FO : Folding
-   MT : Mountain
-   RC : Racer
-   RE : Recumbant
-   RG : Regular
-   SC : Scooter
-   TA : Tandem
-   TO : Touring
-   TR : Tricycle
-   UN : Unicycle
-   OT : Other
-   UNKNOWN : Type Unknown

```{r}
unique(bike_theft$Bike_Type)
```

# Data Cleaning

## Figure out missing data

By running the following code, we notice that there are no variables with missing data

```{r}
bike_theft %>%
  sapply(function(x) sum(is.na(x)))
```

## Figure out variables which have zero (or near zero) variance

In this section, we are interested to know which variables that have zero or near zero variance. This is helpful to make our data clean from variables which has (1) no unique values or (2) significant modus value outnumbered others.

```{r}
caret::nearZeroVar(bike_theft,saveMetrics = TRUE)
```

Notice that though **'Status'** and **'City'** variables still has unique values (zeroVar = FALSE), but their respective modus value is obviously outnumbered the second modus by looking at freqRatio. Hence, their near zero variance (nzv) is classified as TRUE.

The following barchart shows up all available value in **"Status"** variable. We notice that 'Stolen' value is far outnumbered 'Unknown' and 'Recovered', meaning that we might not find any insight from this variable.

Hence, we can delete **"Status"** variable.

```{r, fig.width=12}
bike_theft %>%
  count(Status) %>%
  ggplot(aes(y = reorder(Status, n), x = n)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  geom_text(aes(label=n), position=position_dodge(width=0.8), hjust= -0.2) +
  xlab("Number of Cases") + 
  ylab("Status") +
  ggtitle("Number of Cases by Case Status")
```

For **'City'** variable, we notice that there is 'NSA' value. 'NSA' stands for 'Not Specific Area', meaning the theft case is either located outside the city of Toronto or invalidated locations ( refer to: <https://torontops.maps.arcgis.com/sharing/rest/content/items/c0b17f1888544078bf650f3b8b04d35d/data> ).

As such, we will take out also 'City' Variable.

```{r, fig.width=12}
bike_theft %>%
  count(City) %>%
  ggplot(aes(y = reorder(City, n), x = n)) + 
  geom_bar(stat="identity") + 
  theme_bw() + 
  geom_text(aes(label=n), position=position_dodge(width=0.8), hjust= -0.2) +
  xlab("Number of Cases") + 
  ylab("City") +
  ggtitle("Number of Cases by City")
```

## Exploring Primary Offence Variable

We notice that are 66 possible primary offence types.

```{r}
unique(bike_theft$Primary_Offence)
```

However, looking further at the variable, we figure out the 'theft under' value outnumbered other primary offence types.

Hence, we may take out also **'Primary_Offence'** variable.

```{r, fig.width=12}
bike_theft %>%
  group_by(Primary_Offence) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) %>%
  head(20) %>%
  ggplot(aes(y= reorder(Primary_Offence, n), x= n)) + geom_bar(stat='identity')+
  xlab("Number of Cases") + 
  ylab("Primary Offence") +
  ggtitle("Number of Cases by Primary Offence")
```

## Cleaned Dataset

Here is our dataset looks like after taking out 'Status', 'City', and 'Primary Offence' variables.

```{r}
bike_theft <- bike_theft %>%
  select(-c(Status, City, Primary_Offence))
bike_theft
```

# Exploratory Data Analysis

## Exploring Premises Type

It is understood that bicycle are prone to be stolen when it is parked at outdoor, followed by residential areas like apartments and houses.

```{r, fig.width=12}
bike_theft %>%
  group_by(Premises_Type) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) %>%
  ggplot(aes(y= reorder(Premises_Type, n), x= n)) + geom_bar(stat='identity') +
  geom_text(aes(label=n), position=position_dodge(width=0.8), hjust= -0.2)+
  xlab("Number of Cases") + 
  ylab("Premises Type") +
  ggtitle("Number of Cases by Premises Type")
```

## Exploring Bike Type

Mountain bike becomes the most stolen bike type, followed by Regular.

```{r, fig.width=12}
bike_theft %>%
  group_by(Bike_Type) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) %>%
  ggplot(aes(y= reorder(Bike_Type, n), x= n)) + geom_bar(stat='identity') +
  geom_text(aes(label=n), position=position_dodge(width=0.8), hjust= -0.2) +
  xlab("Number of Cases") + 
  ylab("Premises Type") +
  ggtitle("Number of Cases by Bike Type")
```

## Exploring Cases by Report Day

Notice that the most cases is reported on Monday, while less cases reported on weekends.

```{r}
# by day
bike_theft %>%
  mutate(weekday_name = weekdays(Report_Date)) %>%
  group_by(weekday_name) %>%
  summarise(count = n()) %>%
  ggplot(aes(x=factor(weekday_name, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")), y = count)) + geom_bar(stat='identity') +
  geom_text(aes(label=count), position=position_dodge(width=0.5), vjust= -0.5) +
  ylim(0,5000) +
  xlab("Day of Week") +
  ylab("Number of Cases") +
  ggtitle("Number of Cases by Reported Day") 
```

## Exploring Cases by Neighbourhood

To explore cases by neighbourhood, we are interested to utilise Pareto analysis to determine which neighbourhood that contributes to 50% and 80% of all bicycle theft cases.

To do this, we calculate number of cases by Neighbourhood and arrange in descending manner. Here we add "Cummulative_Percentage" variable to indicate cummulative contribution of each neighbourhood.

```{r}
bike_theft %>%
  group_by(NeighbourhoodName) %>%
  summarise(Frequency = n()) %>%
  arrange(desc(Frequency)) %>%
  mutate(Cummulative_Percentage = cumsum(Frequency)/nrow(bike_theft))
```

From here, we can see **12 neighbourhoods racks up around 50% of overall bike theft cases** in Toronto, while **other 30 neighbourhoods add up the number to around 80%**. Meanwhile the rest **99 neighbourhoods only contributes to 20% of overall bike theft cases**.

### Top 12 Neighbourhood (contribution to number of cases around 50%)

```{r, fig.width=12}
# List of Top 12 Neighbourhoods
top_12_neighbourhood <- bike_theft %>%
  group_by(NeighbourhoodName) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) %>%
  head(12)
top_12_neighbourhood %>%
  ggplot(aes(x= reorder(NeighbourhoodName, n), y= n)) + geom_bar(stat='identity') + coord_flip() + geom_text(aes(label=n), position=position_dodge(width=0.8), hjust= -0.2) +
  xlab("Number of Cases") +
  ylab("Neighbourhood") +
  ggtitle("Number of Cases from Top 12 Neighbourhood (contributed to 50% number of cases)") 
```

Here we are interested to deep dive on exploring **top 12 neighbourhoods by premises type**. We notice that among the neighbourhood group, the majority of bicycle theft occured when the bicycle is parked outside.

```{r, message=FALSE}
# by Premises Type
bike_theft %>%
  filter(NeighbourhoodName %in% c(unique(top_12_neighbourhood$NeighbourhoodName))) %>%
  group_by(NeighbourhoodName, Premises_Type) %>%
  summarise(count = n()) %>%
  ggplot(aes(x=Premises_Type, y = count)) + geom_boxplot()+
  xlab("Premise Type") +
  ylab("Number of Cases") +
  ggtitle("Boxplot Number of Cases from Top 12 Neighbourhood by Premises Type")
```

Deep dive to **Bike Type**, it shows similar pattern to overall neighbourhoods, which Mountain Bike and Regular Bike are the two most stolen bike in Top 12 neighbourhoods.

```{r, message=FALSE}
# by Bike Type
bike_theft %>%
  filter(NeighbourhoodName %in% c(unique(top_12_neighbourhood$NeighbourhoodName))) %>%
  group_by(NeighbourhoodName, Bike_Type) %>%
  summarise(count = n()) %>%
  ggplot(aes(x=Bike_Type, y = count)) + geom_boxplot()+
  xlab("Bike Type") +
  ylab("Number of Cases") +
  ggtitle("Boxplot Number of Cases from Top 12 Neighbourhood by Bike Type")
```

Deep dive to **Reported Day**, it also aligned with our finding in overall neighbourhoods.

```{r, message=FALSE}
# by day
bike_theft %>%
  mutate(weekday_name = weekdays(Report_Date)) %>%
  filter(NeighbourhoodName %in% c(unique(top_12_neighbourhood$NeighbourhoodName))) %>%
  group_by(NeighbourhoodName, weekday_name) %>%
  summarise(count = n()) %>%
  ggplot(aes(x=factor(weekday_name, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")), y = count)) + geom_boxplot() +
  xlab("Day of Week") +
  ylab("Number of Cases") +
  ggtitle("Boxplot Number of Cases from Top 12 Neighbourhood by Reported Day")
```

### Next Top 30 Neighbourhoods (contribution to number of cases around 30%)

```{r, message=FALSE}
# List of Next Top 30 Neighbourhoods
next_top_30_neighbourhood <- bike_theft %>%
  filter(!NeighbourhoodName %in% c(unique(top_10_neighbourhood$NeighbourhoodName))) %>%
  group_by(NeighbourhoodName) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  head(30)
next_top_30_neighbourhood
```

Here we are interested to deep dive on exploring **next top 30 neighbourhoods by premise type**. We notice that among the neighbourhood group, the number of cases are quite similar among outdoor, apartments and houses.

```{r, message=FALSE}
bike_theft %>%
  filter(NeighbourhoodName %in% c(unique(next_top_30_neighbourhood$NeighbourhoodName))) %>%
  group_by(NeighbourhoodName, Premises_Type) %>%
  summarise(count = n()) %>%
  ggplot(aes(x=Premises_Type, y = count)) + geom_boxplot() +
  xlab("Premise Type") +
  ylab("Neighbourhood") +
  ggtitle("Boxplot Number of Cases from Next Top 30 Neighbourhood by Premise Type")
```

Deep dive to **Bike Type**, it shows similar pattern to overall neighbourhoods, which Mountain Bike and Regular Bike are the two most stolen bike in Next Top 30 neighbourhoods.

```{r, message=FALSE}
# by Bike Type
bike_theft %>%
  filter(NeighbourhoodName %in% c(unique(next_top_30_neighbourhood$NeighbourhoodName))) %>%
  group_by(NeighbourhoodName, Bike_Type) %>%
  summarise(count = n()) %>%
  ggplot(aes(x=Bike_Type, y = count)) + geom_boxplot()+
  xlab("Bike Type") +
  ylab("Neighbourhood") +
  ggtitle("Boxplot Number of Cases from Next Top 30 Neighbourhood by Bike Type")
```

Deep dive to **Reported Day**, it also aligned with our finding in overall neighbourhoods.

```{r, message=FALSE}
# by day
bike_theft %>%
  mutate(weekday_name = weekdays(Report_Date)) %>%
  filter(NeighbourhoodName %in% c(unique(next_top_30_neighbourhood$NeighbourhoodName))) %>%
  group_by(NeighbourhoodName, weekday_name) %>%
  summarise(count = n()) %>%
  ggplot(aes(x=factor(weekday_name, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")), y = count)) + geom_boxplot()+
  xlab("Day of Week") +
  ylab("Neighbourhood") +
  ggtitle("Boxplot Number of Cases from Next Top 30 Neighbourhood by Reported Day")
```

### Rest 99 Neighbourhoods (contribution to number of cases around 30%)

```{r}
# List of Rest of Neighbourhoods 
other_neighbourhood <- bike_theft %>%
  filter(!NeighbourhoodName %in% c(unique(top_12_neighbourhood$NeighbourhoodName)) & 
          !NeighbourhoodName %in% c(unique(next_top_30_neighbourhood$NeighbourhoodName))
         ) %>%
  group_by(NeighbourhoodName) %>%
  summarise(count = n()) %>%
  arrange(desc(count))
other_neighbourhood
```

Here we are interested to deep dive on exploring **next top 30 neighbourhoods by premise type**. We notice that the pattern looks quite similar to Next Top 30 Neighbourhoods group, which the number of cases are quite similar among outdoor, apartments and houses.

```{r, message=FALSE}
bike_theft %>%
  filter(NeighbourhoodName %in% c(unique(other_neighbourhood$NeighbourhoodName))) %>%
  group_by(NeighbourhoodName, Premises_Type) %>%
  summarise(count = n()) %>%
  ggplot(aes(x=Premises_Type, y = count)) + geom_boxplot() +
  xlab("Premise Type") +
  ylab("Neighbourhood") +
  ggtitle("Boxplot Number of Cases from The Rest 99 Neighbourhood by Premise Type")
```

Deep dive to **Bike Type**, it shows similar pattern to overall neighbourhoods, which Mountain Bike and Regular Bike are the two most stolen bike in the Rest 99 Neighbourhoods group.

```{r, message=FALSE}
# by Bike Type
bike_theft %>%
  filter(NeighbourhoodName %in% c(unique(other_neighbourhood$NeighbourhoodName))) %>%
  group_by(NeighbourhoodName, Bike_Type) %>%
  summarise(count = n()) %>%
  ggplot(aes(x=Bike_Type, y = count)) + geom_boxplot()+
  xlab("Bike Type") +
  ylab("Neighbourhood") +
  ggtitle("Boxplot Number of Cases from The Rest 99 Neighbourhood by Bike Type")
```

Deep dive to **Reported Day**, it also aligned with our finding in overall neighbourhoods.

```{r, message=FALSE}
# by day
bike_theft %>%
  mutate(weekday_name = weekdays(Report_Date)) %>%
  filter(NeighbourhoodName %in% c(unique(other_neighbourhood$NeighbourhoodName))) %>%
  group_by(NeighbourhoodName, weekday_name) %>%
  summarise(count = n()) %>%
  ggplot(aes(x=factor(weekday_name, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")), y = count)) + geom_boxplot() +
  xlab("Day of Week") +
  ylab("Neighbourhood") +
  ggtitle("Boxplot Number of Cases from The Rest 99 Neighbourhood by Reported Day")
```

## Insights from EDA

From exploratory data analysis above, we can draw insights as follow.

-   12 neighbourhoods are contributed to around 50% of overall reported bicycle theft cases in Toronto from 2014 - 2020. Majority of cases from this neighbourhood group happened when the bicycle is parked outside building premises.

-   Meanwhile, both next top 30 neighbourhoods (contributed to around 30% of total cases) and rest 99 neighbourhoods show similar pattern in terms of theft premises, which the number of cases happened outside building premises, apartments, and houses almost shared the same figures.

-   In terms of stolen bike type and case reported day, there is no significant different pattern across neighbourhoods group.

Interestingly, from EDA we have already had clustering among neighbourhoods based on their contribution to the overall cases as well as premises type. However, we are also interested to reconfirm this argument using K-Means Clustering Analysis.

# Perform K-Means Clustering

## Data Pre-processing

In accordance to the findings from EDA, we only consider 'Neighbourhood' and 'Premise Type' variables as basis of clustering analysis.

Before performing cluster analysis, we need to transform our data so that it displays count of premises type by neighbourhoods.

Noted that there might be missing values as there might be no cases from certain premise type at specific neighbourhood (for instance no bicycle theft cases in Apartments at Bayview Woods-Steeles). Hence, we replace the missing values with 0.

```{r, message=FALSE}
# transform data
bike_theft_clustering <- bike_theft %>%
  group_by(NeighbourhoodName, Premises_Type) %>%
  summarise(count = n()) %>%
  pivot_wider(NeighbourhoodName, names_from = Premises_Type, values_from =count)

bike_theft_clustering <- data.frame(bike_theft_clustering)

# replace missing values with 0
bike_theft_clustering[is.na(bike_theft_clustering)] <- 0

bike_theft_clustering
```

After we transform the data, clustering analysis requires us to let the data in numerical standardize values only. To solve this, we let Neighbourhood names as row names instead of being part of data frame and standardize the values.

```{r}
# Transform the data into ready for K Means Clustering analysis

k_means_bike_theft <- bike_theft_clustering %>%
  select(-NeighbourhoodName)
k_means_bike_theft <- scale(k_means_bike_theft)
rownames(k_means_bike_theft) = bike_theft_clustering$NeighbourhoodName
```

## Determine K value using Elbow Method

Using Elbow Method, we can draw conclusion that *optimal K value is 2* because this is the point where total within sum of square drops a lot.

```{r}
fviz_nbclust(df, kmeans, method = 'wss')
```

## Determine K value using Silhouette Method

Using Silhouette Method, we can draw conclusion that *optimal K value is 2* because this is the point where average silhouette width is higher.

```{r}
fviz_nbclust(df, kmeans, method = 'silhouette')
```

## Final K-Means Clustering

The finding from following cluster plot is aligned with our previous argument from exploratory data analysis, which we can classify neighbourhoods based on bicycle theft premises type.

All the 12 neighbourhoods that contribute to 50% bicycle theft cases can classify into a single group where bicycle theft mostly happened outside building premises.

Meanwhile, the rest 129 neighbourhoods will be classified into another group where the number of bicycle theft cases are mostly shared in outside building premises, apartments and houses.

```{r}
k_2 = kmeans(k_means_bike_theft, centers = 2, nstart = 50)
fviz_cluster(k_2, data = k_means_bike_theft)
```

```{r}
#List of Top 12 Neighbourhood
unique(top_12_neighbourhood$NeighbourhoodName)
```

# Conclusion

Toronto Police needs to pay attention to 12 neighbourhoods that contribute to 50% bicycle theft cases, particularly to the bicycles that are parked outside building premises.
